# Visualization Studio

**Category:** Function-Based Framework > Exploration

---

## Purpose

Quick, consistent plots with controlled styles and saved code snippets for reuse. Generate publication-ready figures with minimal manual adjustment.

---

## Inputs

- Any table from `artifacts/**` or `data/**`
- Optional: plot specifications in `configs/plot_style.yaml`

---

## Outputs

**Artifacts:**
- `artifacts/visualization_studio/run_<id>/*.png` - Generated figures
- `reports/visualization_studio/run_<id>/gallery.md` - Figure gallery with descriptions
- `artifacts/visualization_studio/snippets/*.py` - Reusable Python code for each figure

---

## System Prompt

```
Generate ready-to-paste figures: KM curves for {endpoint}, forest plot for subgroups, calibration at 5y/10y, and save minimal Python that can recreate each figure.
```

---

## Security Permissions

```json
{
  "model": "claude-sonnet-4-5-20250929",
  "permissions": {
    "allow": [
      "Read(/artifacts/**)",
      "Read(/data/**)",
      "Read(/configs/plot_style.yaml)",
      "Write(/artifacts/visualization_studio/**)",
      "Write(/reports/visualization_studio/**)",
      "Write(/logs/**)"
    ],
    "deny": [
      "Network(*)",
      "Bash(*)",
      "Write(/data/**)"
    ]
  }
}
```

---

## Plot Style Configuration

```yaml
# configs/plot_style.yaml

style:
  theme: "seaborn-v0_8-whitegrid"
  font_family: "Arial"
  font_size_title: 14
  font_size_label: 12
  font_size_tick: 10
  dpi: 300
  figure_size: [8, 6]
  color_palette: "colorblind"

km_curves:
  line_width: 2.5
  ci_alpha: 0.15
  at_risk_table: true
  median_line: true
  legend_location: "upper right"

forest_plot:
  marker_size: 80
  marker_color: "#1f77b4"
  line_width: 1.5
  reference_line_style: "dashed"
  sort_by: "estimate"

calibration:
  scatter_alpha: 0.4
  perfect_line_style: "dashed"
  perfect_line_color: "gray"
  loess_line_width: 2.5

bar_chart:
  bar_width: 0.7
  edge_color: "black"
  edge_width: 0.5
  value_labels: true
```

---

## Figure Gallery Template

```markdown
# Visualization Gallery - Run <id>

**Generated:** 2025-11-09
**Run ID:** 20251109_170000_vizstudio

---

## 1. Kaplan-Meier Curve - Overall Cohort

![KM Overall](km_overall.png)

**Description:** Kaplan-Meier curve for distant recurrence in full cohort (n=1,240).

**Key Features:**
- 95% confidence bands (shaded)
- At-risk table below x-axis
- Median survival: 8.4 years [95% CI: 7.2-9.6]

**Code:** `snippets/km_overall.py`

---

## 2. Kaplan-Meier by Risk Group

![KM Risk Groups](km_by_risk_group.png)

**Description:** KM curves stratified by model-predicted risk (low/high at median split).

**Key Features:**
- Two groups: Low risk (n=620), High risk (n=620)
- Log-rank p<0.001
- 5-year survival: Low 92.3% vs High 82.3%

**Code:** `snippets/km_by_risk_group.py`

---

## 3. Forest Plot - Subgroup Analysis

![Forest Plot](forest_subgroups.png)

**Description:** Hazard ratios for model (vs clinical baseline) across pre-specified subgroups.

**Key Features:**
- Point estimates with 95% CIs
- Overall effect at bottom
- Sorted by effect size
- p-value for interaction included

**Code:** `snippets/forest_subgroups.py`

---

## 4. Calibration Plot - 5 Years

![Calibration 5y](calibration_5y.png)

**Description:** Observed vs predicted risk at 5-year horizon.

**Key Features:**
- Perfect calibration line (dashed gray)
- Smoothed LOESS fit
- ECE = 0.042 (good)
- 10 risk deciles

**Code:** `snippets/calibration_5y.py`

---

## 5. Delta C-index Bar Chart

![Delta C](delta_cindex_bar.png)

**Description:** ΔC-index (model vs baseline) across cohorts.

**Key Features:**
- Error bars: 95% CI
- Reference line at 0
- Cohorts sorted by effect size
- Significant differences marked (*)

**Code:** `snippets/delta_cindex_bar.py`

---

## 6. Time-Dependent AUC Curve

![AUC(t)](auc_t_curve.png)

**Description:** AUC(t) from 0 to 10 years with confidence bands.

**Key Features:**
- Shaded 95% CI
- Horizons of interest marked (5y, 10y)
- Flat AUC indicates consistent performance over time

**Code:** `snippets/auc_t_curve.py`

---

## Usage Notes

1. All figures are 300 DPI, publication-ready
2. Color palette is colorblind-safe
3. Code snippets can be run standalone with minimal dependencies
4. Modify `configs/plot_style.yaml` to customize appearance
```

---

## Code Snippet Example

### snippets/km_overall.py

```python
"""
Kaplan-Meier Curve - Overall Cohort
Generated by Visualization Studio
Run ID: 20251109_170000_vizstudio
"""

import pandas as pd
import matplotlib.pyplot as plt
from lifelines import KaplanMeierFitter
from lifelines.plotting import add_at_risk_counts

# Load data
cohort = pd.read_parquet("data/cohort.parquet")

# Fit KM
kmf = KaplanMeierFitter()
kmf.fit(cohort['time'], cohort['event'], label='Overall Cohort')

# Plot
fig, ax = plt.subplots(figsize=(8, 6))
kmf.plot_survival_function(ax=ax, ci_show=True, linewidth=2.5, alpha=0.15)

# Add at-risk table
add_at_risk_counts(kmf, ax=ax)

# Styling
ax.set_xlabel('Time (years)', fontsize=12)
ax.set_ylabel('Survival Probability', fontsize=12)
ax.set_title('Kaplan-Meier Curve: Distant Recurrence-Free Survival', fontsize=14)
ax.grid(True, alpha=0.3)
ax.set_ylim([0, 1])

# Save
plt.tight_layout()
plt.savefig('artifacts/visualization_studio/run_20251109_170000/km_overall.png', dpi=300)
plt.close()

print(f"Median survival: {kmf.median_survival_time_:.2f} years")
print(f"5-year survival: {kmf.survival_function_at_times(5).values[0]:.3f}")
```

---

## Available Figure Types

### 1. Survival Plots
- **Kaplan-Meier curves** (single or stratified)
- **Cumulative incidence** (competing risks)
- **Landmark analysis** (conditional survival)

### 2. Performance Plots
- **ROC curves** (single or multi-model)
- **Precision-Recall curves**
- **Calibration plots** (observed vs expected)
- **Decision curve analysis**

### 3. Comparison Plots
- **Forest plots** (subgroups, meta-analysis)
- **League tables** (model rankings)
- **Delta bar charts** (metric differences)

### 4. Distribution Plots
- **Histograms** (continuous variables)
- **Box plots** (group comparisons)
- **Violin plots** (distributions by group)

### 5. Temporal Plots
- **AUC(t) curves** (time-dependent performance)
- **Calibration over time**
- **Event rate curves**

---

## Typical Usage

```bash
# Generate standard figure set
claude-code task --agent visualization_studio \
  --prompt "Create publication figures: KM overall and by risk group, calibration at 5y/10y, forest plot for subgroups, and delta C-index bar chart."

# Custom figure
claude-code task --agent visualization_studio \
  --prompt "Generate ROC curves comparing 3 models (model_v23, model_v19, cox_baseline) at 5-year horizon. Include AUC values in legend."

# Batch generation
claude-code task --agent visualization_studio \
  --prompt "Generate KM curves for all subgroups defined in resolved_experiment.yaml. Save as separate PNGs with consistent styling."
```

---

## Style Customization

### Fonts

```yaml
font_family: "Arial"        # Or "Helvetica", "Times New Roman"
font_size_title: 14
font_size_label: 12
font_size_tick: 10
```

### Colors

```yaml
color_palette: "colorblind"  # Or "Set2", "husl", custom list
line_colors: ["#1f77b4", "#ff7f0e", "#2ca02c"]
```

### Size

```yaml
figure_size: [8, 6]  # Width x Height in inches
dpi: 300             # Resolution (300 for publication)
```

---

## Publication Checklist

Before using figures in manuscripts:

- [ ] DPI ≥ 300
- [ ] Font sizes readable (≥10pt)
- [ ] Color palette is colorblind-safe
- [ ] Axis labels clear and units specified
- [ ] Legend positioned appropriately
- [ ] No overlapping text
- [ ] Consistent styling across figures
- [ ] File format: PNG or PDF (vector)

---

## Notes

- **Fast iteration:** Modify YAML and regenerate all figures in seconds
- **Reproducibility:** Code snippets ensure exact recreation
- **Collaboration:** Share snippets with team for consistency
- **Flexibility:** Snippets can be customized beyond YAML settings
- **Documentation:** Gallery markdown auto-documents all figures
